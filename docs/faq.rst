:orphan:

.. currentmodule:: qq
.. _faq:

ç»å¸¸é—®çš„é—®é¢˜
===========================

è¿™æ˜¯æœ‰å…³ä½¿ç”¨ ``qq.py`` åŠå…¶æ‰©å±•æ¨¡å—çš„å¸¸è§é—®é¢˜åˆ—è¡¨ã€‚éšæ„æå‡ºä¸€ä¸ªæ–°é—®é¢˜æˆ–é€šè¿‡Pull Requestæäº¤ä¸€ä¸ªã€‚

.. contents:: Questions
    :local:

Coroutines
------------

å…³äºåç¨‹å’Œ asyncio çš„é—®é¢˜å±äºè¿™é‡Œã€‚

ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~

|coroutine_link|_ æ˜¯ä¸€ä¸ªå¿…é¡»ä½¿ç”¨ ``await`` æˆ– ``yield from`` è°ƒç”¨çš„å‡½æ•°ã€‚
å½“ Python é‡åˆ° ``await`` æ—¶ï¼Œå®ƒä¼šåœ¨é‚£ä¸ªç‚¹åœæ­¢å‡½æ•°çš„æ‰§è¡Œå¹¶å¤„ç†å…¶ä»–äº‹æƒ…ï¼Œç›´åˆ°å®ƒå›åˆ°é‚£ä¸ªç‚¹å¹¶å®Œæˆå®ƒçš„å·¥ä½œã€‚
è¿™å…è®¸ä½ çš„ç¨‹åºåŒæ—¶æ‰§è¡Œå¤šé¡¹æ“ä½œï¼Œè€Œæ— éœ€ä½¿ç”¨çº¿ç¨‹æˆ–å¤æ‚çš„å¤šå¤„ç†ã€‚

**å¦‚æœä½ å¿˜è®° await åç¨‹ï¼Œåˆ™åç¨‹å°†ä¸ä¼šè¿è¡Œã€‚æ°¸è¿œä¸è¦å¿˜è®° await åç¨‹ã€‚**

æˆ‘åœ¨å“ªé‡Œå¯ä»¥ä½¿ç”¨ ``await``\ï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

ä½ åªèƒ½åœ¨ ``async def`` å‡½æ•°ä¸­ä½¿ç”¨ ``await``ï¼Œè€Œä¸èƒ½åœ¨å…¶ä»–ä»»ä½•åœ°æ–¹ä½¿ç”¨ã€‚

â€œé˜»å¡â€æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~~~~~~

åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œé˜»å¡è°ƒç”¨æœ¬è´¨ä¸Šæ˜¯å‡½æ•°ä¸­æ‰€æœ‰ä¸æ˜¯ ``await`` çš„éƒ¨åˆ†ã€‚ä½†æ˜¯ä¸è¦ç»æœ›ï¼Œå› ä¸ºå¹¶éæ‰€æœ‰å½¢å¼çš„é˜»å¡éƒ½æ˜¯ä¸å¥½çš„ï¼
ä½¿ç”¨é˜»å¡è°ƒç”¨æ˜¯ä¸å¯é¿å…çš„ï¼Œä½†ä½ å¿…é¡»åŠªåŠ›ç¡®ä¿ä¸ä¼šè¿‡åº¦é˜»å¡å‡½æ•°ã€‚
è¯·è®°ä½ï¼Œå¦‚æœä½ é˜»å¡çš„æ—¶é—´è¿‡é•¿ï¼Œé‚£ä¹ˆä½ çš„æœºå™¨äººå°†å†»ç»“ï¼Œå› ä¸ºå®ƒæ­¤æ—¶å°šæœªåœæ­¢å‡½æ•°çš„æ‰§è¡Œä»¥æ‰§è¡Œå…¶ä»–æ“ä½œã€‚

å¦‚æœå¯ç”¨æ—¥å¿—è®°å½•ï¼Œæ­¤åº“å°†å°è¯•è­¦å‘Šä½ æ­£åœ¨å‘ç”Ÿé˜»å¡å¹¶æ˜¾ç¤ºæ¶ˆæ¯ï¼š
``å¿ƒè·³è¢«é˜»å¡è¶…è¿‡ N ç§’ã€‚``
æœ‰å…³å¯ç”¨æ—¥å¿—è®°å½•çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… :ref:`logging_setup`ã€‚

é˜»å¡æ—¶é—´è¿‡é•¿çš„å¸¸è§åŸå› æ˜¯ :func:`time.sleep`ã€‚ä¸è¦é‚£æ ·åšã€‚ä½¿ç”¨ :func:`asyncio.sleep` ä»£æ›¿ã€‚ç±»ä¼¼äºè¿™ä¸ªä¾‹å­ï¼š ::

    # åå
    time.sleep(10)

    # å¾ˆå¥½
    await asyncio.sleep(10)

é˜»å¡æ—¶é—´è¿‡é•¿çš„å¦ä¸€ä¸ªå¸¸è§åŸå› æ˜¯ä½¿ç”¨å¸¦æœ‰è‘—åæ¨¡å— :doc:`req:index` çš„ HTTP è¯·æ±‚ã€‚
è™½ç„¶ :doc:`req:index` æ˜¯éå¼‚æ­¥ç¼–ç¨‹çš„ä¸€ä¸ªäº†ä¸èµ·çš„æ¨¡å—ï¼Œä½†å®ƒä¸æ˜¯ :mod:`asyncio` çš„å¥½é€‰æ‹©ï¼Œå› ä¸ºæŸäº›è¯·æ±‚å¯èƒ½ä¼šé˜»å¡äº‹ä»¶å¾ªç¯å¤ªä¹…ã€‚
ç›¸åï¼Œè¯·ä½¿ç”¨ :doc:`aiohttp <aio:index>` åº“ã€‚

è€ƒè™‘ä»¥ä¸‹ç¤ºä¾‹ï¼š ::

    # åå
    r = requests.get('http://aws.random.cat/meow')
    if r.status_code == 200:
        js = r.json()
        await channel.send(js['file'])

    # å¾ˆå¥½
    async with aiohttp.ClientSession() as session:
        async with session.get('http://aws.random.cat/meow') as r:
            if r.status == 200:
                js = await r.json()
                await channel.send(js['file'])

é€šç”¨
---------

å…³äºåº“ä½¿ç”¨çš„ä¸€èˆ¬é—®é¢˜å±äºè¿™é‡Œã€‚

åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°ä½¿ç”¨ç¤ºä¾‹ï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

ç¤ºä¾‹ä»£ç å¯ä»¥åœ¨ `ç¤ºä¾‹æ–‡ä»¶å¤¹ <https://github.com/foxwhite25/qq.py/tree/master/examples>`_ æ‰¾åˆ°ã€‚

å¦‚ä½•å‘ç‰¹å®šé¢‘é“å‘é€æ¶ˆæ¯ï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

ä½ å¿…é¡»ç›´æ¥è·å–é€šé“ï¼Œç„¶åè°ƒç”¨é€‚å½“çš„æ–¹æ³•ã€‚ ä¾‹å­ï¼š ::

    channel = client.get_channel(12324234183172)
    await channel.send('hello')

æˆ‘å¦‚ä½•ç§èŠï¼Ÿ
~~~~~~~~~~~~~~~~~~~

è·å– User æˆ– Member å¯¹è±¡å¹¶è°ƒç”¨ :meth:`abc.Messageable.send` ã€‚ ä¾‹å¦‚ï¼š::

     user = message.author
     await user.send('Hi', reference = message)

å¦‚ä½•è·å–å·²å‘é€æ¶ˆæ¯çš„ IDï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

:meth:`abc.Messageable.send` è¿”å›å‘é€çš„:class:`Message`ã€‚
æ¶ˆæ¯çš„ ID å¯ä»¥é€šè¿‡ :attr:`Message.id` è®¿é—®ï¼š ::

     message = await channel.send('å—¯...')
     message_id = message.id


å¦‚ä½•å‘æ¶ˆæ¯æ·»åŠ è¡¨æƒ…ï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

ä½ éœ€è¦ä½¿ç”¨ :meth:`Message.add_reaction` æ–¹æ³•ã€‚

å¦‚æœè¦ä½¿ç”¨ unicode è¡¨æƒ…ç¬¦å·ï¼Œåˆ™å¿…é¡»åœ¨å­—ç¬¦ä¸²ä¸­ä¼ é€’æœ‰æ•ˆçš„ unicode ä»£ç ç‚¹ã€‚ åœ¨ä½ çš„ä»£ç ä¸­ï¼Œä½ å¯ä»¥ç”¨å‡ ç§ä¸åŒçš„æ–¹å¼ç¼–å†™å®ƒï¼š
- ``'ğŸ‘'``
- ``'\U0001F44D'``
- ``'\N{THUMBS UP SIGN}'``

ç¤ºä¾‹ï¼š::

    emoji = '\N{THUMBS UP SIGN}'
    # or '\U0001f44d' or 'ğŸ‘'
    await message.add_reaction(emoji)

å¯¹äºè‡ªå®šä¹‰è¡¨æƒ…ç¬¦å·ï¼Œä½ åº”è¯¥ä¼ é€’ä¸€ä¸ª PartialEmoji å®ä¾‹ã€‚ ä½ ä¹Ÿå¯ä»¥ä¼ é€’ä¸€ä¸ª``'emoji:id'`` å­—ç¬¦ä¸²ï¼Œä½†æ˜¯å¦‚æœä½ 
å¯ä»¥ä½¿ç”¨ä¸Šè¿°è¡¨æƒ…ç¬¦å·ï¼Œä½ åº”è¯¥å¯ä»¥ä½¿ç”¨:meth:`PartialEmoji.from_str` é€šè¿‡IDè·å–è¡¨æƒ…ç¬¦å·ã€‚
è¡¨æƒ…ç¬¦å· ID å¯ä»¥é€šè¿‡æ¶ˆæ¯è·å–ï¼Œæˆ–è€…åœ¨å®˜æ–¹æ–‡æ¡£è·å–ã€‚

ç¤ºä¾‹ï¼š::

    await message.add_reaction('emoji:10')

æˆ‘å¦‚ä½•åœ¨åå°è¿è¡Œä¸€äº›ä¸œè¥¿ï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

`æ£€æŸ¥ background_task.py ç¤ºä¾‹ã€‚ <https://github.com/foxwhite25/qq.py/blob/master/examples/background_task.py>`_

æˆ‘å¦‚ä½•è·å¾—ç‰¹å®šå¯¹è±¡ï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

æœ‰å¤šç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ å¦‚æœä½ æœ‰ç‰¹å®šå¯¹è±¡çš„ IDï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹åŠŸèƒ½ä¹‹ä¸€ï¼š

- :meth:`Client.get_channel`
- :meth:`Client.get_guild`
- :meth:`Client.get_user`
- :meth:`Guild.get_member`
- :meth:`Guild.get_channel`
- :meth:`Guild.get_role`

ä»¥ä¸‹ä½¿ç”¨ HTTP è¯·æ±‚ï¼š

- :meth:`Client.fetch_user`
- :meth:`Client.fetch_guilds`
- :meth:`Client.fetch_guild`
- :meth:`Guild.fetch_member`


å¦‚æœä¸Šè¿°å‡½æ•°å¯¹ä½ æ²¡æœ‰å¸®åŠ©ï¼Œé‚£ä¹ˆä½¿ç”¨ :func:`utils.find` æˆ– :func:`utils.get` å°†æœ‰åŠ©äºæŸ¥æ‰¾ç‰¹å®šå¯¹è±¡ã€‚

å¿«é€Ÿç¤ºä¾‹ï¼š ::

    # æŒ‰åç§°æŸ¥æ‰¾é¢‘é“
    guild = qq.utils.get(client.guilds, name='My Server')

    # ç¡®ä¿æ£€æŸ¥å®ƒæ˜¯å¦è¢«æ‰¾åˆ°
    if guild is not None:
        # æŒ‰åç§°æŸ¥æ‰¾å­é¢‘é“
        channel = qq.utils.get(guild.text_channels, name='cool-channel')

å¦‚ä½•å‘å‡ºç½‘ç»œè¯·æ±‚ï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

è¦å‘å‡ºè¯·æ±‚ï¼Œä½ åº”è¯¥ä½¿ç”¨éé˜»å¡åº“ã€‚
è¿™ä¸ªåº“å·²ç»ä½¿ç”¨å¹¶éœ€è¦ä¸€ä¸ª ç¬¬ä¸‰æ–¹åº“æ¥å‘å‡ºè¯·æ±‚ï¼Œ:doc:`aiohttp <aio:index>` ã€‚

å¿«é€Ÿç¤ºä¾‹: ::

    async with aiohttp.ClientSession() as session:
        async with session.get('http://aws.random.cat/meow') as r:
            if r.status == 200:
                js = await r.json()

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… `aiohttp çš„å®Œæ•´æ–‡æ¡£ <http://aiohttp.readthedocs.io/en/stable/>`_ ã€‚

å‘½ä»¤æ‰©å±•
-------------------

 ``qq.ext.commands`` æœ‰å…³çš„é—®é¢˜ã€‚

ä¸ºä»€ä¹ˆå®šä¹‰ ``on_message`` ä¹‹åæˆ‘çš„å‘½ä»¤ç”¨ä¸äº†äº†ï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

è¦†ç›–é»˜è®¤æä¾›çš„ ``on_message`` ç¦æ­¢è¿è¡Œä»»ä½•é¢å¤–çš„å‘½ä»¤ã€‚ è¦è§£å†³æ­¤é—®é¢˜ï¼Œè¯·åœ¨ ``on_message`` æœ«å°¾æ·»åŠ  ``bot.process_commands(message)`` è¡Œã€‚ ä¾‹å¦‚ï¼š ::

    @bot.event
    async def on_message(message):
        # åœ¨è¿™é‡Œåšä¸€äº›é¢å¤–çš„äº‹æƒ…

        await bot.process_commands(message)

æˆ–è€…ï¼Œä½ å¯ä»¥å°† ``on_message`` é€»è¾‘æ”¾å…¥ **listener**ã€‚ åœ¨æ­¤è®¾ç½®ä¸­ï¼Œä½ ä¸åº”è¯¥æ‰‹åŠ¨è°ƒç”¨ ``bot.process_commands()`` ã€‚ è¿™ä¹Ÿå…è®¸ä½ å¼‚æ­¥åœ°åšå¤šé¡¹å“åº”åˆ°ä¸€æ¡æ¶ˆæ¯ã€‚ ä¾‹å­::

    @bot.listen('on_message')
    async def whatever_you_want_to_call_it(message):
        # åœ¨è¿™é‡Œåšäº‹
        # è¿™é‡Œä¸å¤„ç†å‘½ä»¤

ä¸ºä»€ä¹ˆæˆ‘çš„å‚æ•°éœ€è¦å¼•å·?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

åœ¨ä¸€ä¸ªç®€å•çš„å‘½ä»¤ä¸­å®šä¹‰ä¸ºï¼š ::

    @bot.command()
    async def echo(ctx, message: str):
        await ctx.send(message)

é€šè¿‡ ``?echo a b c`` è°ƒç”¨å®ƒåªä¼šè·å–ç¬¬ä¸€ä¸ªå‚æ•°è€Œå¿½ç•¥å…¶ä½™å‚æ•°ã€‚ è¦è§£å†³æ­¤é—®é¢˜ï¼Œä½ éœ€è¦åœ¨è¾¹ä¸ŠåŠ ä¸Šå¼•å· ``?echo "a b c"`` æˆ–æ·»åŠ å¤šä¸ªä½ éœ€è¦çš„å‚æ•°ã€‚ ä¾‹å­ï¼š ::

    @bot.command()
    async def echo(ctx, a, b, c, message: str):
        await ctx.send(message)

è¿™å°†å…è®¸ä½ ä½¿ç”¨ ``?echo a b c`` è€Œä¸éœ€è¦å¼•å·ã€‚

æˆ‘å¦‚ä½•è·å¾—åŸå§‹çš„ ``Message`` \ï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

:class:`~ext.commands.Context` åŒ…å«è¯¥å±æ€§ï¼Œä½¿ç”¨ :attr:`~.Context.message` è·å–åŸå§‹ä¿¡æ¯ã€‚

ä¾‹å­: ::

    @bot.command()
    async def length(ctx):
        await ctx.send(f'ä½ çš„ç•™è¨€æ˜¯ {len(ctx.message.content)} å­—ç¬¦é•¿åº¦ã€‚')

å¦‚ä½•åˆ›å»ºå­å‘½ä»¤ï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

ä½¿ç”¨ :func:`~ext.commands.group` è£…é¥°å™¨ã€‚ è¿™ä¼šå°†å›è°ƒè½¬æ¢ä¸º :class:`~ext.commands.Group` ï¼Œå®ƒå…è®¸ä½ å°†å‘½ä»¤æ·»åŠ åˆ°ä½œä¸ºâ€œå­å‘½ä»¤â€è¿è¡Œçš„ç»„ã€‚ è¿™äº›ç»„ä¹Ÿå¯ä»¥ä»»æ„åµŒå¥—ã€‚

ä¾‹å­: ::

    @bot.group()
    async def git(ctx):
        if ctx.invoked_subcommand is None:
            await ctx.send('ä¼ é€’äº†æ— æ•ˆçš„ git å‘½ä»¤...')

    @git.command()
    async def push(ctx, remote: str, branch: str):
        await ctx.send(f'Pushing to {remote} {branch}')

è¿™å¯ä»¥ç”¨ä½œ ``?git push origin master``ã€‚
